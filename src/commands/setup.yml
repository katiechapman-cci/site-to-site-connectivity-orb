---
description: >
  Setup CircleCI tunnel for site to site connectivity

parameters:
  ngrok-api-token:
    type: env_var_name
    description: "Environment variable name containing the Ngrok API token"
    default: NGROK_API_TOKEN
  ip-policy-id:
    type: env_var_name
    description: >
      Environment variable name containing the IP policy ID for the
      CircleCI tunnel
    default: IP_POLICY_ID
  tunnel-address:
    type: env_var_name
    description: >
      Environment variable name containing the tunnel address for the
      CircleCI tunnel
    default: "TUNNEL_ADDRESS"
  tunnel-port:
    type: env_var_name
    description: >
      Environment variable name containing the tunnel port for the
      CircleCI tunnel
    default: "TUNNEL_PORT"
  verify-tunnel:
    type: boolean
    description: "Verify the connection before exiting"
    default: true
  verify-tunnel-attempts:
    type: integer
    description: "Number of attempts before failing to verify the tunnel"
    default: 30
  debug:
    type: boolean
    description: "Enable debug mode"
    default: false

steps:
  - run:
      environment:
        PARAM_NGROK_API_TOKEN: << parameters.ngrok-api-token >>
        PARAM_IP_POLICY_ID: << parameters.ip-policy-id >>
        PARAM_TUNNEL_ADDRESS: << parameters.tunnel-address >>
        PARAM_TUNNEL_PORT: << parameters.tunnel-port >>
        PARAM_VERIFY_TUNNEL: << parameters.verify-tunnel >>
        PARAM_VERIFY_TUNNEL_ATTEMPTS: << parameters.verify-tunnel-attempts >>
        DEBUG: << parameters.debug >>
      name: Setup the CircleCI tunnel
      command: <<include(scripts/setup.sh)>>
